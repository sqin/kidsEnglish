<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµè§ˆå™¨å½•éŸ³åŠŸèƒ½è¯Šæ–­</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
    }
    .check {
      display: flex;
      align-items: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .pass {
      background: #d4edda;
      color: #155724;
    }
    .fail {
      background: #f8d7da;
      color: #721c24;
    }
    .warn {
      background: #fff3cd;
      color: #856404;
    }
    .icon {
      font-size: 24px;
      margin-right: 10px;
    }
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    .button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
    }
    .button:hover {
      background: #0056b3;
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #results {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ” æµè§ˆå™¨å½•éŸ³åŠŸèƒ½è¯Šæ–­</h1>

  <div class="card">
    <h2>åŸºç¡€æ”¯æŒæ£€æŸ¥</h2>
    <div id="basic-checks"></div>
  </div>

  <div class="card">
    <h2>API å¯ç”¨æ€§</h2>
    <div id="api-checks"></div>
  </div>

  <div class="card">
    <h2>è®¾å¤‡æ£€æµ‹</h2>
    <div id="device-checks"></div>
  </div>

  <div class="card">
    <h2>å®é™…æµ‹è¯•</h2>
    <p>ç‚¹å‡»æŒ‰é’®æµ‹è¯•å½•éŸ³åŠŸèƒ½ï¼š</p>
    <button class="button" id="test-btn">æµ‹è¯•å½•éŸ³</button>
    <div id="test-results"></div>
  </div>

  <div class="card">
    <h2>è¯¦ç»†æ—¥å¿—</h2>
    <div id="results"></div>
  </div>

  <script>
    const results = document.getElementById('results');

    function log(message) {
      const time = new Date().toLocaleTimeString();
      results.textContent += `[${time}] ${message}\n`;
      results.scrollTop = results.scrollHeight;
    }

    function addCheck(container, title, passed, message, type = 'pass') {
      const div = document.createElement('div');
      div.className = `check ${type}`;
      div.innerHTML = `
        <span class="icon">${type === 'pass' ? 'âœ…' : type === 'warn' ? 'âš ï¸' : 'âŒ'}</span>
        <div>
          <strong>${title}</strong><br>
          <small>${message}</small>
        </div>
      `;
      document.getElementById(container).appendChild(div);
    }

    // åŸºç¡€æ£€æŸ¥
    const basicChecks = [
      {
        name: 'navigator å¯¹è±¡',
        check: () => typeof navigator !== 'undefined',
        message: () => typeof navigator !== 'undefined' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'
      },
      {
        name: 'HTTPS è¿æ¥',
        check: () => location.protocol === 'https:' || location.hostname === 'localhost',
        message: () => location.protocol === 'https:' || location.hostname === 'localhost'
          ? `æ˜¯ (${location.protocol})`
          : `å¦ (${location.protocol} - éœ€è¦HTTPSæˆ–localhost)`
      },
      {
        name: 'ç”¨æˆ·äº¤äº’',
        check: () => true,
        message: () => 'æ˜¯'
      }
    ];

    basicChecks.forEach(check => {
      const passed = check.check();
      addCheck('basic-checks', check.name, passed, check.message(), passed ? 'pass' : 'fail');
      log(`åŸºç¡€æ£€æŸ¥ - ${check.name}: ${check.message()}`);
    });

    // API æ£€æŸ¥
    const apiChecks = [
      {
        name: 'navigator.mediaDevices',
        check: () => navigator.mediaDevices !== undefined,
        message: () => navigator.mediaDevices !== undefined
          ? 'å¯ç”¨'
          : 'ä¸å¯ç”¨'
      },
      {
        name: 'navigator.mediaDevices.getUserMedia',
        check: () => navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === 'function',
        message: () => navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === 'function'
          ? 'å¯ç”¨'
          : 'ä¸å¯ç”¨'
      },
      {
        name: 'navigator.getUserMedia (æ—§ç‰ˆ)',
        check: () => typeof navigator.getUserMedia === 'function',
        message: () => typeof navigator.getUserMedia === 'function'
          ? 'å¯ç”¨'
          : 'ä¸å¯ç”¨'
      },
      {
        name: 'MediaRecorder',
        check: () => typeof MediaRecorder !== 'undefined',
        message: () => typeof MediaRecorder !== 'undefined'
          ? 'å¯ç”¨'
          : 'ä¸å¯ç”¨'
      },
      {
        name: 'MediaRecorder.isTypeSupported',
        check: () => MediaRecorder.isTypeSupported !== undefined,
        message: () => MediaRecorder.isTypeSupported !== undefined
          ? 'å¯ç”¨'
          : 'ä¸å¯ç”¨'
      }
    ];

    apiChecks.forEach(check => {
      const passed = check.check();
      const type = passed ? 'pass' : 'fail';
      const message = check.message();
      addCheck('api-checks', check.name, passed, message, type);
      log(`API æ£€æŸ¥ - ${check.name}: ${message}`);
    });

    // è®¾å¤‡æ£€æŸ¥
    if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const audioDevices = devices.filter(d => d.kind === 'audioinput');
          const videoDevices = devices.filter(d => d.kind === 'videoinput');

          addCheck('device-checks', 'éŸ³é¢‘è¾“å…¥è®¾å¤‡', audioDevices.length > 0,
            `${audioDevices.length} ä¸ªè®¾å¤‡`, audioDevices.length > 0 ? 'pass' : 'warn');
          addCheck('device-checks', 'è§†é¢‘è¾“å…¥è®¾å¤‡', videoDevices.length > 0,
            `${videoDevices.length} ä¸ªè®¾å¤‡`, videoDevices.length > 0 ? 'pass' : 'warn');

          log(`è®¾å¤‡æ£€æµ‹ - éŸ³é¢‘è¾“å…¥: ${audioDevices.length} ä¸ª`);
          log(`è®¾å¤‡æ£€æµ‹ - è§†é¢‘è¾“å…¥: ${videoDevices.length} ä¸ª`);

          audioDevices.forEach((device, index) => {
            log(`  éŸ³é¢‘è®¾å¤‡ ${index + 1}: ${device.label || 'æœªçŸ¥'}`);
          });
        })
        .catch(err => {
          addCheck('device-checks', 'è®¾å¤‡æšä¸¾', false, `å¤±è´¥: ${err.message}`, 'fail');
          log(`è®¾å¤‡æ£€æµ‹å¤±è´¥: ${err.message}`);
        });
    } else {
      addCheck('device-checks', 'è®¾å¤‡æšä¸¾', false, 'ä¸æ”¯æŒ', 'fail');
      log('è®¾å¤‡æ£€æµ‹ä¸æ”¯æŒ');
    }

    // æµ‹è¯•å½•éŸ³
    document.getElementById('test-btn').addEventListener('click', async () => {
      const btn = document.getElementById('test-btn');
      const testResults = document.getElementById('test-results');
      testResults.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';
      log('å¼€å§‹å½•éŸ³æµ‹è¯•');

      try {
        // æ£€æŸ¥ API å¯ç”¨æ€§
        if (!navigator.mediaDevices && !navigator.getUserMedia) {
          throw new Error('æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³ API');
        }

        // å°è¯•è·å–æƒé™
        log('è¯·æ±‚éº¦å…‹é£æƒé™...');
        const constraints = {
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        };

        let stream;
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        } else {
          stream = await new Promise((resolve, reject) => {
            navigator.getUserMedia(constraints, resolve, reject);
          });
        }

        log('âœ… æˆåŠŸè·å–éŸ³é¢‘æµ');

        // æ£€æŸ¥ MediaRecorder
        if (!MediaRecorder) {
          log('âš ï¸ MediaRecorder ä¸å¯ç”¨ï¼Œä½†å¯ä»¥è·å–éŸ³é¢‘æµ');
          testResults.innerHTML = '<p style="color: green;">âœ… éƒ¨åˆ†æˆåŠŸï¼šå¯ä»¥è·å–éŸ³é¢‘æµï¼Œä½†æ— æ³•å½•åˆ¶</p>';
        } else {
          // æµ‹è¯• MediaRecorder
          let mimeType = 'audio/webm;codecs=opus';
          if (!MediaRecorder.isTypeSupported(mimeType)) {
            if (MediaRecorder.isTypeSupported('audio/webm')) {
              mimeType = 'audio/webm';
            } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
              mimeType = 'audio/mp4';
            } else {
              mimeType = '';
            }
          }

          log(`ä½¿ç”¨éŸ³é¢‘æ ¼å¼: ${mimeType || 'è‡ªåŠ¨'}`);

          const mediaRecorder = new MediaRecorder(stream, {
            mimeType: mimeType || undefined
          });

          const audioChunks = [];
          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
            log(`âœ… å½•åˆ¶æˆåŠŸï¼éŸ³é¢‘å¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);
            testResults.innerHTML = `
              <p style="color: green;">âœ… æµ‹è¯•æˆåŠŸï¼</p>
              <p>éŸ³é¢‘æ ¼å¼: ${mediaRecorder.mimeType || 'è‡ªåŠ¨'}</p>
              <p>æ–‡ä»¶å¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB</p>
            `;

            // æ¸…ç†
            stream.getTracks().forEach(track => track.stop());
            btn.disabled = false;
            btn.textContent = 'æµ‹è¯•å½•éŸ³';
          };

          mediaRecorder.start();
          log('å¼€å§‹å½•åˆ¶...');

          setTimeout(() => {
            mediaRecorder.stop();
          }, 1000);
        }

      } catch (err) {
        log(`âŒ æµ‹è¯•å¤±è´¥: ${err.name} - ${err.message}`);
        testResults.innerHTML = `<p style="color: red;">âŒ æµ‹è¯•å¤±è´¥: ${err.message}</p>`;
        btn.disabled = false;
        btn.textContent = 'æµ‹è¯•å½•éŸ³';
      }
    });

    log('è¯Šæ–­å®Œæˆ');
  </script>
</body>
</html>
